<div class="row">
    <div class="col-12">
        <p class="content-header" i18n>Mortgage</p>
        <p class="content-sub-header" *ngIf="update" i18n>Update your mortgage.</p>
        <p class="content-sub-header" *ngIf="!update" i18n>Add a new mortgage to one of your property.</p>
    </div>
</div>

<div *ngIf="errorMessage" class="row">
    <div class="col-lg-12 col-xs-12">
        <div class='error'>
            <p>ERROR ERROR ERROR TODO</p>
            <p>
                <a href="/login?returnUrl=/app/financing/list">Login Again</a>
            </p>
        </div>
    </div>
</div>

<div *ngIf="isLoading" class="row">
    <div class="col-lg-12 col-xs-12">
        <div>
            <p i18n>Loading...</p>
        </div>
    </div>
</div>

<div *ngIf="!isLoading" class="row">
    <div class="col-lg-12 col-md-12 col-xs-12">
        <form novalidate="novalidate" [formGroup]="loanForm" (ngSubmit)="onSubmit(loanForm)">
            <input type="hidden" id="eid" name="eid" formControlName="eid">

            <!-- Details -->
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title mb-0">Mortgage Details</h4>
                </div>
                <div class="card-body">
                    <div class="px-3">
                        <div class="form-body row">
                            <label for="financialInstitution.eid" class="col-xs-12 col-lg-2 control-label" i18n>Financial Institution</label>
                            <div class="col-xs-12 col-lg-3">
                                <fieldset formGroupName="financialInstitution">
                                    <select id="financialInstitution.eid" name="financialInstitution.eid" formControlName="eid" data-theme="bootstrap" data-placeholder="Choose a Financial Institution..."
                                        class="form-control select2" i18n-data-placeholder>
                                        <option *ngFor="let fi of financialInstitutions" [ngValue]="fi.eid">
                                            {{ fi.name }}
                                        </option>
                                    </select>
                                </fieldset>
                            </div>
                            <label for="amount" class="col-xs-12 col-lg-2 control-label" i18n>Total Amount</label>
                            <div class="col-xs-12 col-lg-3 input-group">
                                <input type="number" class="form-control" id="amount" name="amount" placeholder="" formControlName="amount">
                                <span class="input-group-addon">$</span>
                            </div>
                        </div>
                        <div class="form-body row">
                            <label for="property" class="col-xs-12 col-lg-2 control-label" i18n>Property</label>
                            <div class="col-xs-12 col-lg-3">
                                <fieldset formGroupName="property">
                                    <select id="property" name="property" formControlName="eid" data-theme="bootstrap" data-placeholder="Choose the related property..."
                                        class="form-control select2" i18n-data-placeholder>
                                        <option *ngFor="let fi of properties" [ngValue]="fi.eid">
                                            {{ fi.name }}
                                        </option>
                                    </select>
                                </fieldset>
                            </div>
                            <label for="amount" class="col-xs-12 col-lg-2 control-label" i18n>Interest Rate</label>
                            <div class="col-xs-12 col-lg-3 input-group">
                                <input type="number" class="form-control" id="interestRate" name="interestRate" placeholder="" formControlName="interestRate">
                                <span class="input-group-addon">%</span>
                            </div>
                        </div>
                        <div class="form-body row">
                            <label for="Payment Frequency" class="col-xs-12 col-lg-2 control-label" i18n>Payment Frequency</label>
                            <div class="col-xs-12 col-lg-3 input-group">
                                <select id="paymentFrequency" name="paymentFrequency" formControlName="paymentFrequency" data-theme="bootstrap" data-placeholder="Choose the payment frequency..."
                                    class="form-control select2" i18n-data-placeholder>
                                    <option *ngFor="let pf of paymentFrequencies" [ngValue]="pf.code">
                                        {{ pf.value }}
                                    </option>
                                </select>
                            </div>
                            <label for="amount" class="col-xs-12 col-lg-2 control-label" i18n>Interest Rate</label>
                            <div class="col-xs-12 col-lg-3 input-group">
                                <input type="number" class="form-control" id="interestRate" name="interestRate" placeholder="" formControlName="interestRate">
                                <span class="input-group-addon">%</span>
                            </div>
                        </div>
                        <div class="form-body row">
                            <label for="amortization" class="col-xs-12 col-lg-2 control-label" i18n>Amortization (Years)</label>
                            <div class="col-xs-12 col-lg-3 input-group">
                                <input type="number" class="form-control" id="amortization" name="amortization" placeholder="" formControlName="amortization">
                            </div>
                            <label for="loanCreationDate" class="col-xs-12 col-lg-2 control-label" i18n>Opening Date</label>
                            <div class="col-xs-12 col-lg-3 input-group">
                                <input type="date" id="loanCreationDate" class="form-control input-md" name="loanCreationDate" formControlName="loanCreationDate" data-toggle="tooltip" data-trigger="hover" data-placement="top" data-title="Opening Date">
                                <div class="input-group-addon">
                                  <i class="fa fa-calendar" style="cursor: pointer;"></i>
                                </div>
                            </div>
                        </div>
                        <div class="form-body row">
                            <label for="balance" class="col-xs-12 col-lg-2 control-label" i18n>Last Known Balance</label>
                            <div class="col-xs-12 col-lg-3 input-group">
                                <input type="number" class="form-control" id="balance" name="balance" placeholder="" formControlName="balance">
                                <span class="input-group-addon">$</span>
                            </div>
                            <label for="balanceDate" class="col-xs-12 col-lg-2 control-label" i18n>Last Known Balance Date</label>
                            <div class="col-xs-12 col-lg-3 input-group">
                                <input type="date" id="balanceDate" class="form-control input-md" name="balanceDate" formControlName="balanceDate" data-toggle="tooltip" data-trigger="hover" data-placement="top" data-title="Balance Date">
                                <div class="input-group-addon">
                                  <i class="fa fa-calendar" style="cursor: pointer;"></i>
                                </div>
                            </div>
                        </div> 
                        <div class="form-body row">
                            <label for="renewalDate" class="col-xs-12 col-lg-2 control-label" i18n>Renewal Date</label>
                            <div class="col-xs-12 col-lg-3 input-group">
                                <input type="date" id="renewalDate" class="form-control input-md" name="renewalDate" formControlName="renewalDate" data-toggle="tooltip" data-trigger="hover" data-placement="top" data-title="Renewal Date">
                                <div class="input-group-addon">
                                  <i class="fa fa-calendar" style="cursor: pointer;"></i>
                                </div>
                            </div>
                        </div>                                                                       
                    </div>
                </div>

                <div class="card-footer">
                    <button type="button" (click)="onSubmit(this.loanForm)" [disabled]="!loanForm.valid" class="btn btn-primary btn-raised" i18n>Save</button>
                    <button type="button" (click)="cancel()" class="btn btn-secondary " i18n>Cancel</button>
                </div>
            </div>
            <div *ngIf="loan != null && loan.eid && loan.documents.length > 0" class="card">
                <div class="card-header">
                    <h4 class="card-title mb-0">Mortgage Documentation</h4>
                </div>
                <div class="card-body">
                    <div class="px-3">
                        <label for="uploadeddoc">Uploaded documents for this mortgage</label>
                        <ul class="list-group row">
                            <li class="list-group-item" *ngFor="let doc of loan.documents; let i = index;">
                                <button type="button" (click)="deleteDocument(i, doc.eid)" class="btn btn-secondary" i18n>
                                    <i class="ft-trash-2"></i>
                                </button>
                                <a href="{{ environment.apiUrl }}/document/{{doc.eid}}" target="_blank">
                                    {{doc.fileName}}
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
                <div class="card-footer">
                    &nbsp;
                </div>
            </div>

            <div *ngIf="loan != null && loan.eid" class="card">
                <div class="card-header">
                    <h4 class="card-title mb-0">Add Mortgage Documentation</h4>
                </div>
                <div class="card-body">
                    <div class="px-3">
                        <label for="uploadeddoc">Upload any document related to this mortgage for reference purposes</label>
                        <div ng2FileDrop [ngClass]="{'nv-file-over': hasBaseDropZoneOver}" (fileOver)="fileOverBase($event)" [uploader]="uploader"
                            class="py-5 mb-3 text-center font-medium-5 text-uppercase grey my-drop-zone">
                            &nbsp;Drop New Files here
                            <br/>(pdf, doc, jpg)
                        </div>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th width="50%">Name</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr *ngFor="let item of uploader.queue">
                                    <td>
                                        <strong>{{ item?.file?.name }}</strong>
                                    </td>
                                    <td class="text-center">
                                        <span *ngIf="item.isSuccess">
                                            <i class="glyphicon glyphicon-ok"></i>
                                        </span>
                                        <span *ngIf="item.isCancel">
                                            <i class="glyphicon glyphicon-ban-circle"></i>
                                        </span>
                                        <span *ngIf="item.isError">
                                            <i class="glyphicon glyphicon-remove"></i>
                                        </span>
                                    </td>
                                    <td nowrap>
                                        <button type="button" class="btn btn-success btn-xs btn-raised" (click)="item.upload()" [disabled]="item.isReady || item.isUploading || item.isSuccess">
                                            <span class="glyphicon glyphicon-upload"></span> Upload
                                        </button>
                                        <button type="button" class="btn btn-warning btn-xs btn-raised" (click)="item.cancel()" [disabled]="!item.isUploading">
                                            <span class="glyphicon glyphicon-ban-circle"></span> Cancel
                                        </button>
                                        <button type="button" class="btn btn-danger btn-xs btn-raised" (click)="item.remove()">
                                            <span class="glyphicon glyphicon-trash"></span> Remove
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>

                        <div>
                            <div>
                                Queue progress:
                                <div class="progress">
                                    <div class="progress-bar" role="progressbar" [ngStyle]="{ 'width': uploader.progress + '%' }"></div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-success btn-s btn-raised" (click)="uploader.uploadAll()" [disabled]="!uploader.getNotUploadedItems().length">
                                <span class="glyphicon glyphicon-upload"></span> Upload all
                            </button>
                            <button type="button" class="btn btn-warning btn-s btn-raised" (click)="uploader.cancelAll()" [disabled]="!uploader.isUploading">
                                <span class="glyphicon glyphicon-ban-circle"></span> Cancel all
                            </button>
                            <button type="button" class="btn btn-danger btn-s btn-raised" (click)="uploader.clearQueue()" [disabled]="!uploader.queue.length">
                                <span class="glyphicon glyphicon-trash"></span> Remove all
                            </button>
                        </div>
                        <button type="button" (click)="onSubmit(this.loanForm)" [disabled]="!loanForm.valid" class="btn btn-primary btn-sm btn-raised"
                            i18n>Save</button>
                        <button type="button" (click)="cancel()" class="btn btn-secondary btn-sm btn-raised" i18n>Cancel</button>
                    </div>
                </div>
                <div class="card-footer">
                    &nbsp;
                </div>
            </div>
        </form>
    </div>
</div>